<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.hans.mapper.UserMapper">

    <!--
        在MyBatis的标签中可以使用功能强大的OGNL表达式语言
        MyBatis在动态SQL中支持一下几种标签
            if
            choose (when\otherwise)
            trim (where\set)
            foreach
            bind
    -->

    <select id="selectByUser" resultType="cn.hans.model.SysUser">
        select
          id
          , user_name
          , user_password
          , user_email
          , user_info
          , head_img
          , create_time
        from
          sys_user
        <!--
          这样写当不想使用user_email作为查询条件时则没有办法通过入参来控制SQL语句，只能在接口中再写一个方法。
        where
          user_name like concat('%', #{userName}, '%')
          and user_email = #{userEmail}
          下面的写法则可以通过入参来动态改变SQL语句的查询条件。
        -->
        <where>
            <!--
                where 1 = 1
                当if条件都不满足的时候，where标签中没有元素，则在生成的SQL语句中不会出现where子句
                当if条件至少满足一个时，where标签的内容是以and开头的条件，而MyBatis在生成SQL语句时会自动去掉where标签内开头的and
            -->
            <if test="userName != null and userName != ''">
                and user_name like concat('%', #{userName}, '%')
            </if>
            <if test="userEmail != '' and userEmail != null">
                and user_email  = #{userEmail}
            </if>
        </where>
    </select>

    <!--
        where和set标签的功能都可以用trim标签来实现，并在在底层都是通过TrimSqlNode实现
        trim标签有如下属性：
            prefix：当trim元素内包含内容时，会给内容增加prefix属性值作为前缀
            prefixOverrides：当trim元素内包含内容时，会把内容中匹配的前缀字符串去掉
            suffix：当trim元素内包含内容时，会给内容增加suffix属性值作为后缀
            suffixOverrides：当trim元素内包含内容时，会把内容中匹配的后缀字符串去掉
    -->

    <update id="updateByIdSelective">
        update sys_user
        <set>
          <!--
            set标签的重要作用是：如果set标签的内容是以逗号(,)结尾的就将这个逗号剔除
            若果set标签内没有内容，生成的SQL语句就没有set子句，这样仍然会出现SQL错误，所以set标签仍然没有解决全部问题
          -->
              id = #{id},
          <if test="userName != null and userName != ''">
              user_name = #{userName},
          </if>
          <if test="userEmail != null and userEmail != ''">
              user_email = #{userEmail},
          </if>
          <if test="userPassword != null and userPassword != ''">
              user_password = #{userPassword},
          </if>
          <if test="userInfo != null and userInfo != ''">
              user_info = #{userInfo},
          </if>
          <if test="headImg != null">
              head_img = #{headImg, jdbcType=BLOB},
          </if>
          <if test="createTime != null">
              create_time = #{createTime, jdbcType=TIMESTAMP},
          </if>
        </set>
        where
          id = #{id}
    </update>

    <update id="updateNone">
    <!--
        语法错误
    -->
        update sys_user
        where id = {id}
    </update>

    <select id="selectById" resultType="SysUser">
        select id, user_name, user_email, user_password, user_info, head_img, create_time
        from sys_user
        where id = #{id}
    </select>

    <insert id="insertSelectiveEmail" useGeneratedKeys="true" keyProperty="id">
        <bind name="print" value="@cn.hans.util.TestBase@printParam(_parameter)"/>
        insert into sys_user (
          user_name, user_password
          <if test="userEmail != '' and userEmail != null">
              <!--
                需要判断userEmail != null, 否则user_email字段并没有使用默认值
                即：userEmail != '' 不能判断出来userEmail为null的情况，当userEmail为null时userEmail != null 判断结果为真
              -->
              ,user_email
          </if>
        )
        values (
          #{userName}, #{userPassword}
          <if test="userEmail != null and userEmail != ''">
              , #{userEmail}
          </if>
        )
    </insert>

    <select id="selectByIdOrUserName" resultType="SysUser">
        select id, user_name, user_password, user_email, user_info, head_img, create_time
        from sys_user
        where 1 = 1
        <choose>
            <when test="id != null and id != ''">
                and id = #{id}
            </when>
            <when test="userEmail != null and userEmail != ''">
                and user_email = #{userEmail}
            </when>
            <otherwise>
                and 1 = 2
            </otherwise>
        </choose>
    </select>

</mapper>